# "org" ensures this Service is used with the correct Serverless Framework Access Key.
org: 21betmaster
# "app" enables Serverless Framework Dashboard features and sharing them with other Services.
app: betmaster21
service: blackjack-trainer-backend

provider:
  name: aws
  runtime: python3.9
  region: us-east-1 # You can change this to your preferred region
  httpApi:
    cors:
      allowedOrigins:
        - http://localhost:8081
        - https://localhost:8081
        - http://localhost:19006
        - http://localhost:8082
      allowedHeaders:
        - Content-Type
        - Authorization
      allowedMethods:
        - POST
        - GET
        - PUT
        - OPTIONS
  iam:
    role:
      statements:
        - Effect: "Allow"
          Action:
            - "dynamodb:Query"
            - "dynamodb:Scan"
            - "dynamodb:GetItem"
            - "dynamodb:PutItem"
            - "dynamodb:UpdateItem"
            - "dynamodb:DeleteItem"
          Resource:
            - "arn:aws:dynamodb:${aws:region}:${aws:accountId}:table/${self:provider.environment.USERS_TABLE}"
            - "arn:aws:dynamodb:${aws:region}:${aws:accountId}:table/${self:provider.environment.STATS_TABLE}"
        - Effect: "Allow"
          Action:
            - "ses:SendEmail"
          Resource: "*"
  environment:
    APP_NAME: BetMaster21
    SECRET_KEY: ${env:SECRET_KEY, 'your-super-secret-key'}
    USERS_TABLE: UsersTable
    STATS_TABLE: StatsTable
    SES_REGION: us-east-1
    SES_FROM_EMAIL: 21betmaster@gmail.com

functions:
  signup:
    handler: handlers/auth.signup
    events:
      - httpApi:
          path: /signup
          method: post
  login:
    handler: handlers/auth.login
    events:
      - httpApi:
          path: /login
          method: post
  googleAuth:
    handler: handlers/auth.google_auth
    events:
      - httpApi:
          path: /google-auth
          method: post
  saveMandatoryDetails:
    handler: handlers/auth.save_mandatory_details
    events:
      - httpApi:
          path: /mandatory-details
          method: put
  getMandatoryDetails:
    handler: handlers/auth.get_mandatory_details
    events:
      - httpApi:
          path: /mandatory-details
          method: get
  getProfile:
    handler: handlers/auth.get_profile
    events:
      - httpApi:
          path: /user/profile
          method: get
  updateProfile:
    handler: handlers/auth.update_profile
    events:
      - httpApi:
          path: /user/profile
          method: put
  changePassword:
    handler: handlers/auth.change_password
    events:
      - httpApi:
          path: /user/password
          method: put
  forgotPassword:
    handler: handlers/auth.forgot_password
    events:
      - httpApi:
          path: /auth/forgot-password
          method: post
  verifyOtp:
    handler: handlers/auth.verify_otp
    events:
      - httpApi:
          path: /auth/verify-otp
          method: post
  resetPassword:
    handler: handlers/auth.reset_password
    events:
      - httpApi:
          path: /auth/reset-password
          method: post
  saveStats:
    handler: handlers/stats.save
    events:
      - httpApi:
          path: /stats
          method: post
          # authorizer:
          #   name: jwtAuthorizer
          #   type: jwt
          #   identitySource: "$request.header.Authorization"
          #   issuerUrl: "https://your-issuer-url/.well-known/jwks.json" # This needs to be configured properly
          #   audience:
          #     - "your-audience"

resources:
  Resources:
    UsersTable:
      Type: "AWS::DynamoDB::Table"
      Properties:
        TableName: ${self:provider.environment.USERS_TABLE}
        AttributeDefinitions:
          - AttributeName: "email"
            AttributeType: "S"
        KeySchema:
          - AttributeName: "email"
            KeyType: "HASH"
        BillingMode: "PAY_PER_REQUEST"
    StatsTable:
      Type: "AWS::DynamoDB::Table"
      Properties:
        TableName: ${self:provider.environment.STATS_TABLE}
        AttributeDefinitions:
          - AttributeName: "userId"
            AttributeType: "S"
          - AttributeName: "timestamp"
            AttributeType: "S"
        KeySchema:
          - AttributeName: "userId"
            KeyType: "HASH"
          - AttributeName: "timestamp"
            KeyType: "RANGE"
        BillingMode: "PAY_PER_REQUEST"

plugins:
  - serverless-python-requirements

custom:
  pythonRequirements:
    dockerizePip: false
    pythonBin: python3
    pipCmdExtraArgs:
      - --platform
      - manylinux2014_x86_64
      - --only-binary=:all:
